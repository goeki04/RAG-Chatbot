env AZURE_CLIENT_SECRET;

worker_processes auto;

events {
    worker_connections 1024;
}

http {
    lua_package_path "/usr/local/openresty/luajit/lib/lua/5.1/?.lua;/usr/local/openresty/lualib/?.lua;;";
    
    lua_ssl_trusted_certificate /etc/ssl/certs/ca-certificates.crt;
    lua_ssl_verify_depth 3;

    resolver 127.0.0.11 8.8.8.8 1.1.1.1 valid=30s ipv6=off;
    lua_shared_dict discovery 1m;
    lua_shared_dict jwks 1m;

    upstream qdrant_cluster {
        server vdb_1:6333 max_fails=3 fail_timeout=10s;
        server vdb_2:6333 max_fails=3 fail_timeout=10s;
        keepalive 64;
    }

    server {
        listen 80;

        set $azure_client_id "78d6118c-85ef-4009-8873-1fce155bc843";
        set $azure_discovery "https://login.microsoftonline.com/0ae51e19-07c8-4e4b-bb6d-648ee58410f4/v2.0/.well-known/openid-configuration";

        location /callback {
            access_by_lua_block {
                local openidc = require("resty.openidc")
                local secret = os.getenv("AZURE_CLIENT_SECRET")
                
                if not secret or secret == "" then
                    ngx.log(ngx.ERR, "AZURE_CLIENT_SECRET NOT SET")
                    return ngx.exit(500)
                end

                local opts = {
                    discovery = ngx.var.azure_discovery,
                    client_id = ngx.var.azure_client_id,
                    secret = secret,
                    -- Versuche es mal so:
                    scope = "openid",
                    ssl_verify = "yes",
                    redirect_uri = "http://localhost:8080/callback",
                    discovery_cache_dict = "discovery",
                    jwks_cache_dict = "jwks"
                }
                
                local res, err = openidc.authenticate(opts)
                if err then
                    ngx.log(ngx.ERR, "Callback Auth Error: " .. err)
                    return ngx.exit(401)
                end
            }
        }

        location / {
            access_by_lua_block {
                local openidc = require("resty.openidc")
                local method = ngx.req.get_method()

                local origin = ngx.var.http_origin
                if origin then
                    ngx.header["Access-Control-Allow-Origin"] = origin
                    ngx.header["Vary"] = "Origin"
                    ngx.header["Access-Control-Allow-Credentials"] = "true"
                    ngx.header["Access-Control-Allow-Methods"] = "GET,POST,PUT,PATCH,DELETE,OPTIONS"
                    ngx.header["Access-Control-Allow-Headers"] = ngx.var.http_access_control_request_headers or "Authorization,Content-Type"
                end

                if method == "OPTIONS" then
                    ngx.status = 204
                    return ngx.exit(204)
                end

                local secret = os.getenv("AZURE_CLIENT_SECRET")
                if not secret or secret == "" then return ngx.exit(500) end

                local opts = {
                    discovery = ngx.var.azure_discovery,
                    client_id = ngx.var.azure_client_id,
                    secret = secret,
                    ssl_verify = "yes",
                   -- Versuche es mal so:
                    scope = "openid",
                    redirect_uri = "http://localhost:8080/callback",
                    discovery_cache_dict = "discovery",
                    jwks_cache_dict = "jwks"
                }
                
                local res, err = openidc.authenticate(opts)

                if err then
                    ngx.status = 401
                    ngx.say("Auth failed: " .. err)
                    return ngx.exit(401)
                end

                local roles = res.user.roles or {}
                if type(roles) == "string" then roles = { roles } end

                local function has_role(target)
                    for _, r in ipairs(roles) do if r == target then return true end end
                    return false
                end

                local is_admin  = has_role("admin")
                local is_rw     = has_role("project_a.rw")
                local is_viewer = has_role("project_a.reader")

                if not (is_admin or is_rw or is_viewer) then
                    ngx.status = 403
                    ngx.say("Forbidden: No roles assigned")
                    return ngx.exit(403)
                end

                if method == "DELETE" and not is_admin then
                    ngx.status = 403
                    return ngx.exit(403)
                end

                if (method == "POST" or method == "PUT" or method == "PATCH") and not (is_admin or is_rw) then
                    ngx.status = 403
                    return ngx.exit(403)
                end
            }

            proxy_pass http://qdrant_cluster;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_connect_timeout 5s;
            proxy_read_timeout 60s;
            proxy_next_upstream error timeout http_502 http_503 http_504;
            proxy_next_upstream_tries 2;
        }
    }
}